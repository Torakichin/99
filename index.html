<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ã«ã‚ƒã‚“ã“ä¹ä¹ç·´ç¿’å¸³</title>
<link rel="icon" type="image/jpeg" href="neko.jpg">
<link rel="apple-touch-icon" href="neko.jpg">
<style>
body{
  margin:0;
  background:url('kabe.jpg') repeat;
  background-size:cover;
  font-family:"Noto Sans JP",sans-serif;
  user-select:none;
  overflow:hidden;
  position:relative;
}
#app{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;position:relative;}
.card{background:rgba(255,255,255,0.95);padding:24px;border-radius:14px;box-shadow:0 6px 30px rgba(0,0,0,0.1);width:480px;max-width:95%;position:relative;overflow:hidden;}
h1{text-align:center;margin:0 0 10px;font-size:26px;}
h2#modeTitle{text-align:center;margin:0 0 12px;font-size:18px;color:#333;}
#menu{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin-bottom:10px;}
button{cursor:pointer;border:0;border-radius:8px;padding:8px 14px;background:#1976d2;color:#fff;font-weight:700;}
button.secondary{background:#777;}
button:disabled{opacity:0.5;cursor:not-allowed;}
#gameScreen{display:none;position:relative;}
.problem{text-align:center;font-size:30px;margin:10px 0;}
#progress{text-align:center;margin-bottom:6px;font-weight:bold;}
#timer{position:absolute;top:-10px;right:10px;background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:8px;font-weight:800;font-size:22px;}
#answerArea{display:flex;justify-content:center;gap:10px;margin:10px 0;position:relative;}
.answerBox{width:60px;height:60px;border:2px solid #999;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:30px;font-weight:bold;background:#fff;position:relative;overflow:hidden;}
.answerBox.active{border-color:#f33;background:#ffe5e5;}
.answerBox.disabled{opacity:0.4;pointer-events:none;background:#eee;}
.flower-stamp{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;z-index:2;}
.flower-stamp img{width:100%;height:auto;transform:scale(0);opacity:0;animation:popIn 0.6s ease-out forwards;}
@keyframes popIn{
  0%{transform:scale(0);opacity:0;}
  70%{transform:scale(1.2);opacity:1;}
  100%{transform:scale(1);opacity:1;}
}
#numPad{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:10px;}
#numPad button{background:#4caf50;font-size:20px;padding:10px 0;}
.controls{margin-top:12px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;}
#nyanko{position:fixed;bottom:40px;right:40px;width:120px;pointer-events:none;opacity:0.9;animation:sway 3s ease-in-out infinite;transform-origin:center bottom;}
@keyframes sway{
  0%{transform:rotate(0deg);}
  25%{transform:rotate(2deg);}
  50%{transform:rotate(0deg);}
  75%{transform:rotate(-2deg);}
  100%{transform:rotate(0deg);}
}
.jump{animation:jumpTwice 0.6s ease-out;}
@keyframes jumpTwice{
  0%{transform:translateY(0);}
  20%{transform:translateY(-30px);}
  40%{transform:translateY(0);}
  60%{transform:translateY(-20px);}
  100%{transform:translateY(0);}
}
.speech{
  position:fixed;
  bottom:160px;
  right:150px;
  background:#fff;
  padding:8px 12px;
  border-radius:12px;
  border:2px solid #333;
  font-weight:800;
  display:none;
  z-index:10000;
}
#messageText{text-align:center;font-weight:800;margin-top:10px;min-height:40px;}
#rankBox{margin-top:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;display:none;}
#rankBox img{width:180px;height:auto;border-radius:10px;margin-bottom:8px;} /* â†æ‹¡å¤§ */
#nekokanStamp{
  position:fixed;
  top:5px;
  left:5px;
  transform:scale(0);
  opacity:0;
  transition:transform 0.6s ease-out,opacity 0.6s ease-out;
  z-index:9999;
}
#nekokanStamp.show{transform:scale(1);opacity:1;}
</style>
</head>
<body>
<div id="app">
  <div class="card">
    <h1>ã«ã‚ƒã‚“ã“ä¹ä¹ç·´ç¿’å¸³</h1>
    <h2 id="modeTitle"></h2>

    <div id="titleScreen">
      <div id="menu">
        <button data-mode="random">ãƒ©ãƒ³ãƒ€ãƒ </button>
        <button data-mode="1">ä¸€ã®æ®µ</button>
        <button data-mode="2">äºŒã®æ®µ</button>
        <button data-mode="3">ä¸‰ã®æ®µ</button>
        <button data-mode="4">å››ã®æ®µ</button>
        <button data-mode="5">äº”ã®æ®µ</button>
        <button data-mode="6">å…­ã®æ®µ</button>
        <button data-mode="7">ä¸ƒã®æ®µ</button>
        <button data-mode="8">å…«ã®æ®µ</button>
        <button data-mode="9">ä¹ã®æ®µ</button>
      </div>
    </div>

    <div id="gameScreen">
      <div id="timer">00:00</div>
      <div id="progress">1 / 9</div>
      <div class="problem" id="formula">1 Ã— 1 =</div>
      <div id="answerArea">
        <div class="answerBox" id="tens"></div>
        <div class="answerBox" id="ones"></div>
      </div>
      <div id="numPad"></div>
      <div class="controls">
        <button id="resetBtn" class="secondary">ãƒªã‚»ãƒƒãƒˆ</button>
        <button id="checkBtn">åˆ¤å®š</button>
      </div>
      <div id="messageText"></div>
      <button id="backBtn" style="display:none;background:#444;">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
      <div id="rankBox">
        <img id="rankImg" src="">
        <div id="rankLabel"></div>
      </div>
    </div>
  </div>
</div>

<img id="nekokanStamp" src="" alt="ã­ã“ç¼¶ã‚¹ã‚¿ãƒ³ãƒ—">
<img id="nyanko" src="neko.webp" alt="ã«ã‚ƒã‚“ã“">
<div class="speech" id="speechBubble"></div>

<script>
const titleScreen=document.getElementById('titleScreen');
const gameScreen=document.getElementById('gameScreen');
const formula=document.getElementById('formula');
const tensBox=document.getElementById('tens');
const onesBox=document.getElementById('ones');
const numPad=document.getElementById('numPad');
const progress=document.getElementById('progress');
const msg=document.getElementById('messageText');
const backBtn=document.getElementById('backBtn');
const speech=document.getElementById('speechBubble');
const rankBox=document.getElementById('rankBox');
const rankImg=document.getElementById('rankImg');
const rankLabel=document.getElementById('rankLabel');
const modeTitle=document.getElementById('modeTitle');
const timerEl=document.getElementById('timer');
const resetBtn=document.getElementById('resetBtn');
const checkBtn=document.getElementById('checkBtn');
const nyanko=document.getElementById('nyanko');
const nekokan=document.getElementById('nekokanStamp');

let problems=[],current=0,score=0,phase='tens',left,right,mode='';
let startTime,timerId,isChecking=false;

document.querySelectorAll('#menu button').forEach(b=>b.onclick=()=>startGame(b.dataset.mode));

function startGame(m){
  mode = m==='random' ? 'ãƒ©ãƒ³ãƒ€ãƒ ' : `${["","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","ä¸ƒ","å…«","ä¹"][m]}ã®æ®µ`;
  modeTitle.textContent=mode;
  titleScreen.style.display='none';
  gameScreen.style.display='block';
  nekokan.classList.remove('show');
  speech.style.display='none';
  score=0;current=0;problems=[];
  isChecking=false;
  resetBtn.disabled=false;
  checkBtn.disabled=false;
  if(m==='random'){
    let all=[];for(let i=1;i<=9;i++)for(let j=1;j<=9;j++)all.push([i,j]);
    all.sort(()=>Math.random()-0.5);problems=all.slice(0,9);
  }else{for(let i=1;i<=9;i++)problems.push([parseInt(m),i]);}
  rankBox.style.display='none';backBtn.style.display='none';
  startTimer();
  nextProblem();
}

function startTimer(){
  startTime=Date.now();
  clearInterval(timerId);
  timerId=setInterval(()=>{
    const e=Math.floor((Date.now()-startTime)/1000);
    const mm=String(Math.floor(e/60)).padStart(2,'0');
    const ss=String(e%60).padStart(2,'0');
    timerEl.textContent=`${mm}:${ss}`;
  },500);
}
function stopTimer(){
  clearInterval(timerId);
  const sec=Math.floor((Date.now()-startTime)/1000);
  const mm=String(Math.floor(sec/60)).padStart(2,'0');
  const ss=String(sec%60).padStart(2,'0');
  return{sec,text:`${mm}:${ss}`};
}

function nextProblem(){
  isChecking=false;
  checkBtn.disabled=false;
  resetBtn.disabled=false;
  if(current>=problems.length){endGame();return;}
  [left,right]=problems[current];
  formula.textContent=`${left} Ã— ${right} =`;
  tensBox.textContent='';onesBox.textContent='';
  msg.textContent='';
  progress.textContent=`${current+1} / ${problems.length}`;
  const ans=left*right;
  if(ans<10){
    tensBox.classList.add('disabled');
    tensBox.classList.remove('active');
    onesBox.classList.add('active');
    phase='ones';
  }else{
    tensBox.classList.remove('disabled');
    tensBox.classList.add('active');
    onesBox.classList.remove('active');
    phase='tens';
  }
}

function setSpeech(t,persistent=false){
  speech.textContent=t;
  speech.style.display='block';
  // ğŸ”§ persistent = true ã®å ´åˆã¯æ¶ˆã•ãªã„
  if(!persistent){
    if(speech.dataset.persistent!=='true'){
      setTimeout(()=>{if(speech.dataset.persistent!=='true')speech.style.display='none';},1200);
    }
  }
}

for(let i=0;i<=9;i++){
  const b=document.createElement('button');
  b.textContent=i;
  b.onclick=()=>chooseNum(i);
  numPad.appendChild(b);
}

function chooseNum(n){
  if(isChecking)return;
  if(phase==='tens'){
    tensBox.textContent=n;
    tensBox.classList.remove('active');
    onesBox.classList.add('active');
    phase='ones';
  }else{
    onesBox.textContent=n;
    onesBox.classList.remove('active');
  }
}

resetBtn.onclick=()=>{
  if(isChecking)return;
  tensBox.textContent='';onesBox.textContent='';
  if(tensBox.classList.contains('disabled')){
    onesBox.classList.add('active');
    phase='ones';
  }else{
    tensBox.classList.add('active');onesBox.classList.remove('active');
    phase='tens';
  }
};

checkBtn.onclick=()=>{
  if(isChecking)return;
  isChecking=true;
  checkBtn.disabled=true;
  resetBtn.disabled=true;
  const ans=left*right;
  const tens=parseInt(tensBox.textContent||'0',10);
  const ones=parseInt(onesBox.textContent||'0',10);
  const entered=tens*10+ones;
  let correct=false;
  if(ans<10){correct=parseInt(onesBox.textContent)==ans;}
  else{correct=entered===ans;}
  if(correct){
    setSpeech('æ­£è§£ã˜ã‚ƒï¼');msg.textContent='æ­£è§£ï¼';score++;
    showFlower(ans<10?[onesBox]:[tensBox,onesBox]);
    nyanko.classList.add('jump');
    setTimeout(()=>nyanko.classList.remove('jump'),600);
  }else{
    setSpeech('é•ã†ã');msg.textContent='é•ã†ã‚ˆâ€¦';
  }
  current++;
  setTimeout(nextProblem,1000);
};

function showFlower(targetBoxes){
  targetBoxes.forEach(box=>{
    const stamp=document.createElement('div');
    stamp.className='flower-stamp';
    const img=document.createElement('img');
    img.src='hanamaru.png';
    stamp.appendChild(img);
    box.appendChild(stamp);
    setTimeout(()=>stamp.remove(),1000);
  });
}

function endGame(){
  const time=stopTimer();
  msg.innerHTML=`å…¨å•çµ‚äº†ï¼<br>ã‚ãªãŸã®å¾—ç‚¹ã¯ <b>${score}</b> / 9 ç‚¹ï¼<br>ã‹ã‹ã£ãŸæ™‚é–“ï¼š${time.text}`;
  let img='',label='';
  if(score===9){
    const s=time.sec;
    if(s<=25){img='oni.png';label='ã‚ãªãŸã¯ã€Œé¬¼ã«ã‚ƒã‚“ã¾ã€ç´šã§ã™ï¼ã‚ãªãŸã¯ç®—æ•°ã®ç¥ã§ã™ã‹â€¦';}
    else if(s<=30){img='daru_kyasu.png';label='ã‚ãªãŸã¯ã€Œé»’ãƒ€ãƒ«ï¼†é»’ã‚­ãƒ£ã‚¹ã€ç´šã§ã™ï¼ã™ã€ã™ã”ã™ããƒ‡ã‚¹ï¼';}
    else if(s<=35){img='mitama.webp';label='ã‚ãªãŸã¯ã€Œå·«å¥³å§«ãƒŸã‚¿ãƒã€ç´šã§ã™ï¼ã™ã”ã„ã™ã”ï½ã„ï¼';}
    else if(s<=40){img='izanagi.webp';label='ã‚ãªãŸã¯ã€Œæšã®ã‚¤ã‚¶ãƒŠã‚®ã€ç´šã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼';}
    else{img='sanada.png';label='ã‚ãªãŸã¯ã€ŒçœŸç”°å¹¸æ‘ã€ç´šã§ã™ï¼ã‚ˆãã§ãã¾ã—ãŸï¼';}
  }else if(score>=7){img='nanaho.png';label='ã‚ãªãŸã¯ã€Œäº¬å‚ä¸ƒç©‚ã€ç´šã§ã™ã€‚ãã“ãã“ã™ã”ã„ã«ã‚ƒï¼';}
  else{img='neko.png';label='ã‚ãªãŸã¯ã€Œãƒã‚³ã€ç´šã§ã™ã€‚ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚';}
  rankImg.src=img;rankLabel.textContent=label;
  rankBox.style.display='flex';
  backBtn.style.display='inline-block';
  checkBtn.disabled=true;
  resetBtn.disabled=true;
  showNekokanStamp();
  // ğŸ”§ ã€Œã‚ˆãã‚„ã£ãŸï¼ã€ã‚’æ°¸ç¶šè¡¨ç¤º
  speech.dataset.persistent='true';
  setSpeech('ã‚ˆãã‚„ã£ãŸï¼',true);
}

function showNekokanStamp(){
  nekokan.classList.remove('show');
  const rand=Math.random();
  nekokan.src=(rand<0.2)?'nekokanbig.png':'nekokan.png';
  setTimeout(()=>nekokan.classList.add('show'),300);
}

backBtn.onclick=()=>{
  gameScreen.style.display='none';
  titleScreen.style.display='block';
  modeTitle.textContent='';
  nekokan.classList.remove('show');
  speech.dataset.persistent='false';
  speech.style.display='none';
};
</script>
</body>
</html>
